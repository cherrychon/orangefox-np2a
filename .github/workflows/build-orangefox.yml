name: Build OrangeFox R11.x + Installer + OTA for Nothing Phone 2a (pacman)

on:
  workflow_dispatch:

env:
  BUILD_DIR: ${{ github.workspace }}/ofx-build
  OF_MANIFEST: https://gitlab.com/OrangeFox/mirrors/manifest.git
  OF_BRANCH: R11.1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure animation_block.txt exists
        run: |
          if [ ! -f animation_block.txt ]; then
            echo "ERROR: animation_block.txt missing!"
            exit 1
          fi

      - name: Install build dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 lib32z1-dev \
            libx11-dev libgl1-mesa-dev libxml2-utils xsltproc unzip \
            python3 python3-pip rsync ccache repo \
            libncurses5-dev:i386 lib32ncurses6

      - name: Generate version + timestamp
        id: version
        run: |
          DATE=$(date +"%Y-%m-%d-%H%M")
          echo "DATE=$DATE" >> $GITHUB_OUTPUT
          echo "VERSION=R11.x" >> $GITHUB_OUTPUT

      - name: Init OrangeFox manifest (mirror, no auth required)
        run: |
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          repo init -u "$OF_MANIFEST" -b "$OF_BRANCH"
          repo sync -c --no-tags --no-clone-bundle -j8

      - name: Clone Nothing kernel (sm8475)
        run: |
          cd "$BUILD_DIR"
          mkdir -p kernel/nothing
          git clone https://github.com/NothingOSS/android_kernel_msm-5.10_nothing_sm8475.git \
            kernel/nothing/sm8475 --depth=1

      - name: Clone NP2a TWRP device tree
        run: |
          cd "$BUILD_DIR"
          mkdir -p device/nothing
          git clone https://github.com/sidharthify/twrp_device_nothing_pacman.git \
            device/nothing/pacman --depth=1

      - name: Patch BoardConfig for OrangeFox
        run: |
          BCF="$BUILD_DIR/device/nothing/pacman/BoardConfig.mk"

          echo "" >> "$BCF"
          echo "# OrangeFox required flags" >> "$BCF"
          echo "FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := true" >> "$BCF"
          echo "OF_MAINTAINER := xs37" >> "$BCF"
          echo "OF_TARGET_DEVICE := pacman" >> "$BCF"

          echo "# UI" >> "$BCF"
          echo "OF_SCREEN_H := 2400" >> "$BCF"
          echo "OF_STATUS_INDICATOR := 1" >> "$BCF"
          echo "OF_HIDE_NOTCH := 1" >> "$BCF"

          echo "# Magisk" >> "$BCF"
          echo "OF_USE_LATEST_MAGISK := true" >> "$BCF"
          echo "OF_INCLUDE_LATEST_MAGISK := true" >> "$BCF"
          echo "OF_USE_MAGISKBOOT_FOR_ALL_PATCHES := 1" >> "$BCF"

          echo "# AVB / encryption" >> "$BCF"
          echo "OF_PATCH_AVB20 := 1" >> "$BCF"
          echo "OF_NO_TREBLE_COMPATIBILITY_CHECK := 1" >> "$BCF"
          echo "OF_SUPPORT_ALL_BLOCK_OTA_UPDATES := 1" >> "$BCF"

          echo "# OTA" >> "$BCF"
          echo "OF_USE_UPDATE_CHANNEL := 1" >> "$BCF"
          echo "OF_USE_NEW_OTA := 1" >> "$BCF"
          echo "OF_UPDATE_URL := https://github.com/${{ github.repository }}/releases/latest/download/fox.json" >> "$BCF"

      - name: Add OTA channel file
        run: |
          CHAN="$BUILD_DIR/device/nothing/pacman/recovery/root/etc"
          mkdir -p "$CHAN"
          echo "[Channel]" > "$CHAN/fox_update_channel"
          echo "name=Official OrangeFox pacman" >> "$CHAN/fox_update_channel"
          echo "json=https://github.com/${{ github.repository }}/releases/latest/download/fox.json" >> "$CHAN/fox_update_channel"

      - name: Build OrangeFox recovery + installer ZIP
        run: |
          cd "$BUILD_DIR"
          source build/envsetup.sh || true

          # Your PRODUCT_NAME is twrp_pacman
          lunch twrp_pacman-eng

          # Build IMG
          mka recoveryimage -j$(nproc)

          # Try common installer targets
          mka ofox -j$(nproc) \
          || mka foxzip -j$(nproc) \
          || mka orangefox -j$(nproc) \
          || mka recoveryzip -j$(nproc)

      - name: Inject animation_block.txt
        run: |
          OUT="$BUILD_DIR/out/target/product/pacman"
          ZIP=$(ls "$OUT"/*.zip | head -n 1)

          mkdir unzip_dir
          unzip "$ZIP" -d unzip_dir

          cat animation_block.txt >> unzip_dir/META-INF/com/google/android/updater-script

          cd unzip_dir
          zip -r "../$(basename "$ZIP")" .
          cd ..

      - name: Generate fox.json + rename files
        run: |
          OUT="$BUILD_DIR/out/target/product/pacman"
          IMG="$OUT/recovery.img"
          ZIP=$(ls "$OUT"/*.zip | head -n 1)

          VERSION="${{ steps.version.outputs.VERSION }}"
          DATE="${{ steps.version.outputs.DATE }}"
          TAG="OrangeFox-${VERSION}-pacman-${DATE}"

          mv "$IMG" "$OUT/$TAG.img"
          mv "$ZIP" "$OUT/$TAG.zip"

          SHA=$(sha256sum "$OUT/$TAG.zip" | awk '{print $1}')
          SIZE=$(stat -c%s "$OUT/$TAG.zip")
          URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${TAG}.zip"
          TIME=$(date +%s)

          echo "{" > fox.json
          echo "  \"version\": \"$VERSION\"," >> fox.json
          echo "  \"device\": \"pacman\"," >> fox.json
          echo "  \"datetime\": $TIME," >> fox.json
          echo "  \"url\": \"$URL\"," >> fox.json
          echo "  \"filename\": \"$TAG.zip\"," >> fox.json
          echo "  \"filesize\": $SIZE," >> fox.json
          echo "  \"sha256\": \"$SHA\"" >> fox.json
          echo "}" >> fox.json

          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-pacman-R11.x
          path: |
            ${{ env.BUILD_DIR }}/out/target/product/pacman/*.img
            ${{ env.BUILD_DIR }}/out/target/product/pacman/*.zip
            fox.json

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            ${{ env.BUILD_DIR }}/out/target/product/pacman/*.img
            ${{ env.BUILD_DIR }}/out/target/product/pacman/*.zip
            fox.json
