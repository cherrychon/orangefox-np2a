name: Build OrangeFox R11.1 for Nothing Phone 2a (pacman)

on:
  workflow_dispatch:

env:
  BUILD_DIR: ${{ github.workspace }}/ofx-build
  # TWRP minimal manifest (Android 12.1 base)
  TWRP_MANIFEST: https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git
  TWRP_BRANCH: twrp-12.1

  # OrangeFox Recovery source (R11.x branch name is a best guess; may need tweaking)
  OF_RECOVERY_REPO: https://gitlab.com/OrangeFox/bootable/Recovery.git
  OF_RECOVERY_BRANCH: fox_11.1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Android build dependencies (Ubuntu 24.04)
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 lib32z1-dev \
            x11proto-core-dev libx11-dev libgl1-mesa-dev libxml2-utils \
            xsltproc unzip python3 python3-pip repo ccache rsync \
            libncurses5-dev:i386 lib32ncurses6

      - name: Init minimal TWRP 12.1 source tree
        run: |
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"

          repo init -u "$TWRP_MANIFEST" -b "$TWRP_BRANCH"
          repo sync -c --no-tags --no-clone-bundle -j6

      - name: Replace TWRP recovery with OrangeFox recovery (R11.1)
        run: |
          cd "$BUILD_DIR"

          # Remove TWRP bootable/recovery
          rm -rf bootable/recovery

          # Try specific OrangeFox R11.1 branch, fallback to default
          if git clone "$OF_RECOVERY_REPO" -b "$OF_RECOVERY_BRANCH" bootable/recovery; then
            echo "Cloned OrangeFox recovery (branch: $OF_RECOVERY_BRANCH)"
          else
            echo "Branch $OF_RECOVERY_BRANCH not found, cloning default branch..."
            git clone "$OF_RECOVERY_REPO" bootable/recovery
          fi

      - name: Clone Nothing kernel for pacman
        run: |
          cd "$BUILD_DIR"
          mkdir -p kernel/nothing
          git clone https://github.com/NothingOSS/android_kernel_msm-5.10_nothing_sm8475.git \
            kernel/nothing/sm8475 --depth=1

      - name: Clone TWRP device tree for pacman
        run: |
          cd "$BUILD_DIR"
          mkdir -p device/nothing
          git clone https://github.com/sidharthify/twrp_device_nothing_pacman.git \
            device/nothing/pacman --depth=1

      - name: Patch device tree for OrangeFox R11.1
        run: |
          BCF="$BUILD_DIR/device/nothing/pacman/BoardConfig.mk"

          echo "" >> "$BCF"
          echo "# ===== OrangeFox flags (R11.x) =====" >> "$BCF"
          echo "FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := true" >> "$BCF"
          echo "OF_USE_GREEN_LED := true" >> "$BCF"
          echo "OF_STATUS_INDICATOR := 1" >> "$BCF"
          echo "OF_USE_LATEST_MAGISK := true" >> "$BCF"
          echo "OF_INCLUDE_LATEST_MAGISK := true" >> "$BCF"
          echo "OF_DONT_PATCH_ENCRYPTED_DEVICE := 1" >> "$BCF"
          echo "OF_NO_TREBLE_COMPATIBILITY_CHECK := 1" >> "$BCF"
          echo "OF_SUPPORT_ALL_BLOCK_OTA_UPDATES := 1" >> "$BCF"
          echo "OF_DISABLE_MIUI_OTA_BY_DEFAULT := 1" >> "$BCF"
          echo "OF_QUICK_BACKUP_LIST := /boot;/data;" >> "$BCF"

          # basic identity
          echo "OF_MAINTAINER := xs37" >> "$BCF"
          echo "OF_TARGET_DEVICE := pacman" >> "$BCF"

      - name: Setup env and lunch target
        run: |
          cd "$BUILD_DIR"
          source build/envsetup.sh || true

          # Try common lunch combos
          if lunch twrp_pacman-eng; then
            echo "Using lunch target: twrp_pacman-eng"
          elif lunch omni_pacman-eng; then
            echo "Using lunch target: omni_pacman-eng"
          else
            echo "ERROR: Could not lunch twrp_pacman-eng or omni_pacman-eng"
            exit 1
          fi

      - name: Build OrangeFox recoveryimage
        run: |
          cd "$BUILD_DIR"
          # Build recoveryimage only (no zip yet)
          mka recoveryimage -j"$(nproc)"

      - name: Collect outputs
        run: |
          OUT="$BUILD_DIR/out/target/product/pacman"
          ls -la "$OUT" || true

          if [ ! -f "$OUT/recovery.img" ]; then
            echo "Build finished but recovery.img not found!"
            exit 1
          fi

          mkdir -p "$BUILD_DIR/output"
          cp "$OUT/recovery.img" "$BUILD_DIR/output/OrangeFox-pacman-recovery.img"

      - name: Upload recovery artifact
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-pacman-recovery
          path: |
            ${{ env.BUILD_DIR }}/output/OrangeFox-pacman-recovery.img
